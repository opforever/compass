<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Compass</title>
    <script type="module">
        // DO NOT CHANGE THIS SECTION
        // This is a mock Firebase configuration for demonstration.
        // In a real environment, this would be populated with your actual Firebase project config.
        if (typeof __firebase_config === 'undefined') {
            const FIREBASE_CONFIG = {
                apiKey: "MOCK_API_KEY",
                authDomain: "MOCK_AUTH_DOMAIN",
                projectId: "MOCK_PROJECT_ID",
                storageBucket: "MOCK_STORAGE_BUCKET",
                messagingSenderId: "MOCK_SENDER_ID",
                appId: "MOCK_APP_ID"
            };
            window.__firebase_config = JSON.stringify(FIREBASE_CONFIG);
        }
        if (typeof __app_id === 'undefined') {
            window.__app_id = 'default-compass-app';
        }
    </script>
    <style>
        /* General Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #e0e0e0;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        #app {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            width: 100%;
            max-width: 400px;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 1px;
            color: #ffffff;
            margin-bottom: 0;
        }

        #status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background-color: #2a2a2a;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            min-height: 60px;
            width: 90%;
        }
        #compass-status {
            font-size: 0.9em;
            color: #3498db;
        }
        #my-user-id {
            font-size: 0.8em;
            color: #7f8c8d;
            word-break: break-all;
        }
        #my-user-id span {
            font-weight: bold;
            color: #bdc3c7;
        }

        /* Compass Styles */
        #compass-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
        }

        .compass-rose {
            width: 300px;
            height: 300px;
            background-color: #2c3e50;
            background-image:
                conic-gradient(from 90deg, 
                    rgba(255,255,255,0.4) 0deg, rgba(255,255,255,0.4) 1deg, transparent 1deg, transparent 89deg,
                    rgba(255,255,255,0.6) 89deg, rgba(255,255,255,0.6) 91deg, transparent 91deg, transparent 179deg,
                    rgba(255,255,255,0.4) 179deg, rgba(255,255,255,0.4) 181deg, transparent 181deg, transparent 269deg,
                    rgba(255,255,255,0.6) 269deg, rgba(255,255,255,0.6) 271deg, transparent 271deg, transparent 360deg
                ),
                conic-gradient(from 0deg, 
                    #bdc3c7 0deg, #bdc3c7 1deg, transparent 1deg, transparent 29deg,
                    #bdc3c7 29deg, #bdc3c7 31deg, transparent 31deg, transparent 59deg,
                    #bdc3c7 59deg, #bdc3c7 61deg, transparent 61deg, transparent 89deg,
                    #bdc3c7 89deg, #bdc3c7 91deg, transparent 91deg, transparent 360deg
                );
            border-radius: 50%;
            border: 10px solid #7f8c8d;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 
                0 0 10px rgba(0,0,0,0.5),
                inset 0 0 25px rgba(0,0,0,0.5);
        }
        
        .compass-rose::after {
            content: '';
            position: absolute;
            width: 90%;
            height: 90%;
            background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.2), rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }

        #needle {
            width: 280px;
            height: 280px;
            position: absolute;
            z-index: 10;
            transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #needle::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 140px solid #e74c3c;
            position: absolute;
            top: 0;
        }

        #needle::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 140px solid #ecf0f1;
            position: absolute;
            bottom: 0;
        }
        
        .pivot {
            width: 20px;
            height: 20px;
            background: #ecf0f1;
            border-radius: 50%;
            position: absolute;
            z-index: 11;
            border: 3px solid #34495e;
        }

        .rose-text {
            position: absolute;
            font-size: 1.5em;
            font-weight: 600;
            color: #ecf0f1;
            z-index: 5;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }
        .rose-n { top: 10px; } .rose-s { bottom: 10px; } .rose-e { right: 10px; top: 50%; transform: translateY(-50%); } .rose-w { left: 10px; top: 50%; transform: translateY(-50%); }
        .rose-text-small { font-size: 1.1em; font-weight: 400; }
        .rose-ne { top: 50px; right: 50px; } .rose-se { bottom: 50px; right: 50px; } .rose-sw { bottom: 50px; left: 50px; } .rose-nw { top: 50px; left: 50px; }

        #heading {
            font-size: 3em;
            font-weight: 200;
            font-family: 'Courier New', Courier, monospace;
            color: #fff;
            margin: 0;
        }

        /* Remote Users List */
        #remote-users-container {
            width: 100%;
        }
        #remote-users-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #2a2a2a;
            border-radius: 12px;
        }
        #remote-users-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #3a3a3a;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9em;
            color: #bdc3c7;
        }
        #remote-users-list li:last-child {
            border-bottom: none;
        }
        #remote-users-list li:hover {
            background-color: #34495e;
        }
        #remote-users-list li.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        #permission-btn {
            padding: 15px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background: linear-gradient(145deg, #3a9efb, #3498db);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Device Compass</h1>

        <div id="status-container">
            <p id="compass-status">Initializing...</p>
            <p id="my-user-id"></p>
        </div>

        <div id="compass-container">
            <div class="compass-rose">
                <div id="needle"></div>
                <div class="pivot"></div>
                <div class="rose-text rose-n">N</div> <div class="rose-text rose-e">E</div> <div class="rose-text rose-s">S</div> <div class="rose-text rose-w">W</div>
                <div class="rose-text rose-text-small rose-ne">NE</div> <div class="rose-text rose-text-small rose-se">SE</div> <div class="rose-text rose-text-small rose-sw">SW</div> <div class="rose-text rose-text-small rose-nw">NW</div>
            </div>
            <p id="heading">--°</p>
        </div>
        
        <div id="remote-users-container" class="hidden">
            <p>Select a device to sync with:</p>
            <ul id="remote-users-list"></ul>
        </div>
        
        <button id="permission-btn" class="hidden">Activate Compass</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const ui = {
                compassContainer: document.getElementById('compass-container'),
                needle: document.getElementById('needle'),
                headingDisplay: document.getElementById('heading'),
                permissionBtn: document.getElementById('permission-btn'),
                remoteUsersContainer: document.getElementById('remote-users-container'),
                remoteUsersList: document.getElementById('remote-users-list'),
                status: document.getElementById('compass-status'),
                myUserId: document.getElementById('my-user-id'),
            };

            let db, auth, userId, hasCompass, remoteUnsubscribe, presenceInterval;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // --- Robust Compass Detection ---
            async function checkCompassAvailability() {
                return new Promise((resolve) => {
                    if (!('DeviceOrientationEvent' in window)) {
                        resolve(false);
                        return;
                    }

                    const timeout = setTimeout(() => {
                        window.removeEventListener('deviceorientationabsolute', listener);
                        resolve(false); // No event received, assume no compass
                    }, 1500);

                    const listener = (event) => {
                        if (event.alpha !== null && typeof event.alpha !== 'undefined') {
                            clearTimeout(timeout);
                            window.removeEventListener('deviceorientationabsolute', listener);
                            resolve(true); // Valid alpha received, compass exists
                        }
                    };
                    window.addEventListener('deviceorientationabsolute', listener, true);
                });
            }

            async function setupFirebase() {
                try {
                    const firebaseConfig = JSON.parse(window.__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    ui.myUserId.innerHTML = `Your ID: <span>${userId}</span>`;
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    ui.status.textContent = "Error connecting to service.";
                }
            }
            
            function managePresence() {
                if (!userId) return;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                const updatePresence = () => {
                     setDoc(userDocRef, { 
                        hasCompass: hasCompass, // This is now guaranteed to be defined
                        lastSeen: serverTimestamp() 
                    }, { merge: true });
                };
                updatePresence();
                presenceInterval = setInterval(updatePresence, 15000);
            }

            function updateCompassUI(alpha) {
                if (alpha === null || typeof alpha === 'undefined') return;
                ui.needle.style.transform = `rotate(${alpha}deg)`;
                ui.headingDisplay.textContent = `${Math.round(alpha)}°`;
            }

            function handleLocalOrientation(event) {
                let alpha = event.alpha;
                if(typeof event.webkitCompassHeading !== "undefined") {
                    alpha = event.webkitCompassHeading; 
                }
                updateCompassUI(alpha);
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                setDoc(userDocRef, { alpha: alpha }, { merge: true });
            }

            function listenForBroadcasters() {
                ui.remoteUsersContainer.classList.remove('hidden');
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/users`), 
                    where("hasCompass", "==", true)
                );

                onSnapshot(q, (snapshot) => {
                    const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
                    const activeUsers = [];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const lastSeenDate = data.lastSeen?.toDate();
                        if (doc.id !== userId && lastSeenDate && lastSeenDate > tenMinutesAgo) {
                           activeUsers.push(doc);
                        }
                    });

                    ui.remoteUsersList.innerHTML = '';
                    if (activeUsers.length === 0) {
                         ui.remoteUsersList.innerHTML = '<li>No active broadcasters found.</li>';
                         return;
                    }

                    activeUsers.forEach(doc => {
                        const li = document.createElement('li');
                        li.textContent = `User: ${doc.id.substring(0, 8)}...`;
                        li.dataset.id = doc.id;
                        li.addEventListener('click', () => subscribeToBroadcaster(doc.id));
                        ui.remoteUsersList.appendChild(li);
                    });
                }, (error) => {
                    console.error("Error listening for broadcasters:", error);
                    ui.remoteUsersList.innerHTML = '<li>Error loading broadcasters.</li>';
                });
            }

            function subscribeToBroadcaster(broadcasterId) {
                if (remoteUnsubscribe) remoteUnsubscribe();
                
                document.querySelectorAll('#remote-users-list li').forEach(li => {
                    li.classList.toggle('active', li.dataset.id === broadcasterId);
                });

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${broadcasterId}`);
                remoteUnsubscribe = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        updateCompassUI(data.alpha);
                        ui.status.textContent = `Synced with: ${broadcasterId.substring(0,8)}...`;
                    } else {
                        ui.status.textContent = 'Selected user went offline.';
                        if(remoteUnsubscribe) remoteUnsubscribe();
                    }
                });
            }

            // --- Main Execution Logic ---
            await setupFirebase();

            hasCompass = await checkCompassAvailability(); // Reliable check first
            
            managePresence(); // Then manage presence, fixing the error

            if (hasCompass) {
                ui.permissionBtn.classList.remove('hidden');
                ui.status.textContent = 'Local compass available. Press activate.';
                
                const activate = () => {
                    const startListening = () => {
                        window.addEventListener('deviceorientationabsolute', handleLocalOrientation, true);
                        ui.permissionBtn.classList.add('hidden');
                        ui.status.textContent = 'Broadcasting your compass...';
                    };

                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    startListening();
                                } else {
                                    ui.status.textContent = 'Permission denied.';
                                }
                            }).catch(console.error);
                    } else {
                         startListening();
                    }
                };
                ui.permissionBtn.addEventListener('click', activate);

            } else {
                ui.status.textContent = 'No local compass detected. Searching...';
                listenForBroadcasters();
            }
        });
    </script>
</body>
</html>

